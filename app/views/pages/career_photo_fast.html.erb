<% content_for :title, "å¤¢æƒ³è·äººç…§ - çœ‹è¦‹æœªä¾†çš„è‡ªå·±" %>

<style>
  .dream-career-page { max-width: 26rem; margin: 0 auto; padding: 2rem 1rem; font-family: "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif; }
  .dream-career-page .hero { text-align: center; margin-bottom: 2rem; }
  .dream-career-page .hero h1 { font-size: 1.75rem; font-weight: 700; color: #0f766e; margin-bottom: 0.5rem; }
  .dream-career-page .hero .tagline { font-size: 1rem; color: #134e4a; font-weight: 500; }
  .dream-career-page .encourage { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 0.75rem; padding: 1rem 1.25rem; margin-bottom: 2rem; border-left: 4px solid #059669; }
  .dream-career-page .encourage p { margin: 0; font-size: 0.9375rem; color: #065f46; line-height: 1.6; }
  .dream-career-page .encourage strong { color: #047857; }
  .dream-career-page label { display: block; font-weight: 600; margin-bottom: 0.375rem; color: #334155; font-size: 0.9375rem; }
  .dream-career-page input[type="text"], .dream-career-page select { width: 100%; padding: 0.625rem 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: 1rem; margin-bottom: 1rem; }
  .dream-career-page input[type="text"]:focus, .dream-career-page select:focus { outline: none; border-color: #059669; }
  .dream-career-page input[type="file"] { width: 100%; padding: 0.75rem; border: 2px dashed #94a3b8; border-radius: 0.5rem; background: #f8fafc; font-size: 0.875rem; margin-bottom: 1rem; cursor: pointer; }
  .dream-career-page input[type="file"]:hover { border-color: #059669; background: #f0fdf4; }
  .dream-career-page .hint { font-size: 0.75rem; color: #64748b; margin-top: -0.5rem; margin-bottom: 1rem; }
  .dream-career-page button[type="submit"] { width: 100%; padding: 0.875rem 1.25rem; background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border: none; border-radius: 0.5rem; font-size: 1.0625rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3); }
  .dream-career-page button[type="submit"]:hover { background: linear-gradient(135deg, #047857 0%, #065f46 100%); transform: translateY(-1px); }
  .dream-career-page button[type="submit"]:disabled { background: #94a3b8; transform: none; cursor: not-allowed; box-shadow: none; }
  .dream-career-page .result { margin-top: 2rem; padding: 1.25rem; border-radius: 0.75rem; background: #f0fdf4; border: 2px solid #86efac; }
  .dream-career-page .result img { max-width: 100%; height: auto; border-radius: 0.5rem; display: block; margin-top: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .dream-career-page .result .error { color: #dc2626; font-weight: 500; }
  .dream-career-page .result .loading { color: #047857; font-weight: 500; }
  .dream-career-page .preview { max-width: 10rem; max-height: 10rem; object-fit: cover; border-radius: 0.5rem; margin-top: 0.5rem; border: 2px solid #86efac; }
  .dream-career-page .timer { font-size: 1rem; font-weight: 600; color: #059669; margin-bottom: 0.5rem; }
  .dream-career-page .btn-download { display: inline-block; margin-top: 1rem; padding: 0.625rem 1.25rem; background: #059669; color: white; border-radius: 0.5rem; font-weight: 600; text-decoration: none; cursor: pointer; border: none; font-size: 0.9375rem; }
  .dream-career-page .btn-download:hover { background: #047857; }
  .dream-career-page .success-msg { color: #065f46; font-weight: 600; margin-bottom: 0.5rem; }
  .dream-career-page .career-custom { display: none; }
  .dream-career-page .career-custom.visible { display: block; }
  .dream-career-page .gender-options { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
  .dream-career-page .gender-options label { display: inline-flex; align-items: center; gap: 0.375rem; font-weight: 500; cursor: pointer; }
  .dream-career-page .gender-options input[type="radio"] { margin: 0; }
  .dream-career-page .page-footer { margin-top: 3rem; padding-top: 1.5rem; text-align: center; font-size: 0.8125rem; color: #059669; }
</style>

<div class="dream-career-page">
  <div class="hero">
    <h1>âœ¨ å¤¢æƒ³è·äººç…§</h1>
    <p class="tagline">çœ‹è¦‹æœªä¾†çš„è‡ªå·±</p>
  </div>

  <div class="encourage">
    <p><strong>å‹‡æ•¢è¿½å¤¢ï¼Œæœªä¾†å±¬æ–¼ä½ ï¼</strong> ä¸Šå‚³ç…§ç‰‡ã€é¸æ“‡å¤¢æƒ³è·æ¥­ï¼ŒAI å°‡ç‚ºä½ ç”Ÿæˆå°ˆå±¬çš„æœªä¾†è·äººç…§ã€‚æ¯ä¸€å€‹å¤¢æƒ³éƒ½å€¼å¾—è¢«çœ‹è¦‹ï¼Œå …æŒä¸‹å»ï¼Œä½ ä¸€å®šèƒ½æˆç‚ºæƒ³æˆç‚ºçš„äººï¼</p>
  </div>

  <form id="dream-career-form">
    <div>
      <label for="image_file">ä¸Šå‚³ç…§ç‰‡</label>
      <input type="file" id="image_file" name="image_file" accept="image/*" required>
      <p class="hint">è«‹ä¸Šå‚³ä¸€å¼µäººè‡‰æ¸…æ™°çš„è‡ªæ‹ç…§ï¼Œæ–¹ä¾¿ AI è¾¨è­˜ç‰¹å¾µã€‚</p>
      <img id="preview" class="preview" alt="" style="display: none;">
    </div>

    <div>
      <label>æ€§åˆ¥</label>
      <div class="gender-options">
        <label><input type="radio" name="gender" value="ç”·" checked> ç”·</label>
        <label><input type="radio" name="gender" value="å¥³"> å¥³</label>
        <label><input type="radio" name="gender" value=""> ä¸æŒ‡å®š</label>
      </div>
      <p class="hint">è«‹é¸æ“‡ä»¥ç¢ºä¿ç”Ÿæˆæ™‚æ€§åˆ¥æ­£ç¢ºã€‚</p>
    </div>

    <div>
      <label for="student_id">å§“åï¼ˆé¸å¡«ï¼‰</label>
      <input type="text" id="student_id" name="student_id" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
      <p class="hint">æœƒé¡¯ç¤ºåœ¨ç…§ç‰‡ä¸‹æ–¹çš„èªªæ˜æ–‡å­—ä¸­ã€‚</p>
    </div>

    <div>
      <label for="career">æˆ‘çš„å¤¢æƒ³è·æ¥­</label>
      <select id="career" name="career" required>
        <option value="">è«‹é¸æ“‡æˆ–è‡ªè¡Œå¡«å¯«</option>
        <optgroup label="ğŸ³ é£Ÿ">
          <option value="å»šå¸«">å»šå¸«</option>
          <option value="çƒ˜ç„™å¸«">çƒ˜ç„™å¸«</option>
          <option value="ç‡Ÿé¤Šå¸«">ç‡Ÿé¤Šå¸«</option>
          <option value="è¾²å¤«">è¾²å¤«</option>
          <option value="èª¿é…’å¸«">èª¿é…’å¸«</option>
        </optgroup>
        <optgroup label="ğŸ‘” è¡£">
          <option value="æœè£è¨­è¨ˆå¸«">æœè£è¨­è¨ˆå¸«</option>
          <option value="è£ç¸«å¸«">è£ç¸«å¸«</option>
          <option value="æ¨¡ç‰¹å…’">æ¨¡ç‰¹å…’</option>
        </optgroup>
        <optgroup label="ğŸ  ä½">
          <option value="å»ºç¯‰å¸«">å»ºç¯‰å¸«</option>
          <option value="å®¤å…§è¨­è¨ˆå¸«">å®¤å…§è¨­è¨ˆå¸«</option>
          <option value="åœŸæœ¨å·¥ç¨‹å¸«">åœŸæœ¨å·¥ç¨‹å¸«</option>
        </optgroup>
        <optgroup label="âœˆï¸ è¡Œ">
          <option value="é£›è¡Œå“¡">é£›è¡Œå“¡</option>
          <option value="å¤ªç©ºäºº">å¤ªç©ºäºº</option>
          <option value="èˆ¹é•·">èˆ¹é•·</option>
          <option value="åˆ—è»Šé§•é§›">åˆ—è»Šé§•é§›</option>
          <option value="å¸æ©Ÿ">å¸æ©Ÿ</option>
        </optgroup>
        <optgroup label="ğŸ­ å¨›æ¨‚">
          <option value="éŸ³æ¨‚å®¶">éŸ³æ¨‚å®¶</option>
          <option value="æ¼”å“¡">æ¼”å“¡</option>
          <option value="æ­Œæ‰‹">æ­Œæ‰‹</option>
          <option value="æ”å½±å¸«">æ”å½±å¸«</option>
          <option value="ä½œå®¶">ä½œå®¶</option>
          <option value="ç•«å®¶">ç•«å®¶</option>
          <option value="é‹å‹•å“¡">é‹å‹•å“¡</option>
          <option value="éŠæˆ²è¨­è¨ˆå¸«">éŠæˆ²è¨­è¨ˆå¸«</option>
          <option value="ä¸»æŒäºº">ä¸»æŒäºº</option>
          <option value="èˆè¹ˆå®¶">èˆè¹ˆå®¶</option>
        </optgroup>
        <optgroup label="ğŸ’¼ å…¶ä»–">
          <option value="é†«ç”Ÿ">é†«ç”Ÿ</option>
          <option value="è€å¸«">è€å¸«</option>
          <option value="è­·ç†å¸«">è­·ç†å¸«</option>
          <option value="å¾‹å¸«">å¾‹å¸«</option>
          <option value="å·¥ç¨‹å¸«">å·¥ç¨‹å¸«</option>
          <option value="è­¦å¯Ÿ">è­¦å¯Ÿ</option>
          <option value="æ¶ˆé˜²å“¡">æ¶ˆé˜²å“¡</option>
          <option value="ç§‘å­¸å®¶">ç§‘å­¸å®¶</option>
          <option value="ç¸é†«">ç¸é†«</option>
          <option value="é­”è¡“å¸«">é­”è¡“å¸«</option>
          <option value="other">â”â” è‡ªè¡Œå¡«å¯« â”â”</option>
        </optgroup>
      </select>
      <div id="career_custom_wrap" class="career-custom">
        <input type="text" id="career_custom" name="career_custom" placeholder="è«‹è¼¸å…¥ä½ çš„å¤¢æƒ³è·æ¥­">
      </div>
      <p class="hint">æ¶µè“‹é£Ÿè¡£ä½è¡Œå¨›æ¨‚ç­‰å„è¡Œå„æ¥­ï¼Œä¹Ÿå¯è‡ªè¡Œå¡«å¯«ã€‚</p>
    </div>

    <button type="submit" id="submit-btn">ç”Ÿæˆæˆ‘çš„å¤¢æƒ³è·äººç…§</button>
  </form>

  <div id="result" class="result" style="display: none;">
    <div id="timer-display" class="timer" style="display: none;"></div>
    <div id="result-content"></div>
  </div>

  <footer class="page-footer">
    ç¶ è‰²å¥‡è¹Ÿå…¬ç›Šæœå‹™ç¶²å”æœƒæä¾› 2026
  </footer>
</div>

<script>
(function() {
  const form = document.getElementById("dream-career-form");
  const imageFileInput = document.getElementById("image_file");
  const previewImg = document.getElementById("preview");
  const careerSelect = document.getElementById("career");
  const careerCustomWrap = document.getElementById("career_custom_wrap");
  const careerCustomInput = document.getElementById("career_custom");
  const studentIdInput = document.getElementById("student_id");
  const submitBtn = document.getElementById("submit-btn");
  const resultEl = document.getElementById("result");
  const resultContent = document.getElementById("result-content");
  const timerDisplay = document.getElementById("timer-display");

  let timerInterval = null;
  let startTime = 0;

  function getCareerValue() {
    if (careerSelect.value === "other") {
      return (careerCustomInput.value || "").trim();
    }
    return (careerSelect.value || "").trim();
  }

  careerSelect.addEventListener("change", function() {
    if (careerSelect.value === "other") {
      careerCustomWrap.classList.add("visible");
      careerCustomInput.required = true;
      careerCustomInput.focus();
    } else {
      careerCustomWrap.classList.remove("visible");
      careerCustomInput.required = false;
      careerCustomInput.value = "";
    }
  });

  function formatTimeSeq(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const h = String(d.getHours()).padStart(2, "0");
    const min = String(d.getMinutes()).padStart(2, "0");
    const s = String(d.getSeconds()).padStart(2, "0");
    return y + m + day + h + min + s;
  }

  function sanitizeFilename(s) {
    if (!s || !s.trim()) return "æœªå¡«";
    return String(s).replace(/[\\/:*?"<>|]/g, "_").trim().slice(0, 50) || "æœªå¡«";
  }

  function startTimer() {
    startTime = Date.now();
    timerDisplay.style.display = "block";
    timerInterval = setInterval(function() {
      const sec = Math.floor((Date.now() - startTime) / 1000);
      timerDisplay.textContent = "ç”Ÿæˆä¸­â€¦ å·²ç”¨æ™‚ " + sec + " ç§’";
    }, 1000);
  }

  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  function escapeHtml(s) {
    const div = document.createElement("div");
    div.textContent = s;
    return div.innerHTML;
  }

  function formatDateTime(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const h = String(d.getHours()).padStart(2, "0");
    const min = String(d.getMinutes()).padStart(2, "0");
    return y + "/" + m + "/" + day + " " + h + ":" + min;
  }

  function addCaptionToImage(imageDataUrl, studentName, career, callback) {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = function() {
      const w = img.width;
      const h = img.height;
      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
      const name = (studentName && studentName.trim()) ? studentName.trim() : "ã€€";
      const now = formatDateTime(new Date());
      const line1 = "å§“å: " + name + " æˆ‘çš„å¤¢æƒ³ æ˜¯ç•¶ä¸€ä½ " + career;
      const fontSize = Math.max(28, Math.round(w * 0.044));
      const lineHeight = fontSize * 1.4;
      const padX = Math.round(w * 0.03);
      const padY = Math.round(h * 0.03);
      ctx.font = fontSize + "px \"Microsoft JhengHei\", \"PingFang TC\", \"Noto Sans TC\", sans-serif";
      ctx.strokeStyle = "#000";
      ctx.fillStyle = "#fff";
      ctx.lineWidth = fontSize * 0.25;
      ctx.textBaseline = "bottom";
      ctx.textAlign = "left";
      const y1 = h - padY - lineHeight;
      ctx.strokeText(line1, padX, y1);
      ctx.fillText(line1, padX, y1);
      ctx.textAlign = "right";
      const y2 = h - padY;
      ctx.strokeText(now, w - padX, y2);
      ctx.fillText(now, w - padX, y2);
      callback(canvas.toDataURL("image/png"));
    };
    img.onerror = function() { callback(imageDataUrl); };
    img.src = imageDataUrl;
  }

  imageFileInput.addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      previewImg.style.display = "block";
    } else {
      previewImg.style.display = "none";
      previewImg.src = "";
    }
  });

  form.addEventListener("submit", async function(e) {
    e.preventDefault();

    const career = getCareerValue();
    const studentId = studentIdInput.value.trim();
    const gender = (form.querySelector('input[name="gender"]:checked') || {}).value || "";

    if (!career) {
      resultContent.innerHTML = '<span class="error">è«‹é¸æ“‡æˆ–è¼¸å…¥å¤¢æƒ³è·æ¥­ã€‚</span>';
      resultEl.style.display = "block";
      return;
    }

    const file = imageFileInput.files && imageFileInput.files[0];
    if (!file) {
      resultContent.innerHTML = '<span class="error">è«‹ä¸Šå‚³ä¸€å¼µç…§ç‰‡ã€‚</span>';
      resultEl.style.display = "block";
      return;
    }

    const imageUrl = await new Promise(function(resolve) {
      const r = new FileReader();
      r.onload = function() { resolve(r.result); };
      r.readAsDataURL(file);
    });

    submitBtn.disabled = true;
    resultEl.style.display = "block";
    timerDisplay.style.display = "none";
    resultContent.innerHTML = '<span class="loading">âœ¨ æ­£åœ¨ç‚ºä½ ç”Ÿæˆå¤¢æƒ³è·äººç…§ï¼Œç´„ 10â€“30 ç§’ï¼Œè«‹ç¨å€™â€¦</span>';
    startTimer();

    try {
      const res = await fetch("/api/career_photo_fast", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image_url: imageUrl, career: career, gender: gender })
      });
      const data = await res.json();
      const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
      stopTimer();
      timerDisplay.textContent = "å®Œæˆï¼è€—æ™‚ " + elapsedSec + " ç§’";
      timerDisplay.style.display = "block";

      if (data.error) {
        resultContent.innerHTML = '<span class="error">' + escapeHtml(data.error) + '</span>';
        submitBtn.disabled = false;
        return;
      }
      if (data.image_data_url) {
        addCaptionToImage(data.image_data_url, studentId, career, function(captionedDataUrl) {
          const timeSeq = formatTimeSeq(new Date());
          const careerSafe = sanitizeFilename(career);
          const studentSafe = sanitizeFilename(studentId);
          const filename = timeSeq + "_" + careerSafe + "_" + studentSafe + ".png";
          let html = '<p class="success-msg">ğŸ‰ ä½ çš„å¤¢æƒ³è·äººç…§å®Œæˆå›‰ï¼</p>';
          html += '<img src="' + escapeHtml(captionedDataUrl) + '" alt="å¤¢æƒ³è·äººç…§">';
          html += '<button type="button" class="btn-download" data-url="' + escapeHtml(captionedDataUrl) + '" data-filename="' + escapeHtml(filename) + '">ä¸‹è¼‰åœ–ç‰‡</button>';
          resultContent.innerHTML = html;
          resultContent.querySelector(".btn-download").addEventListener("click", function() {
            const url = this.getAttribute("data-url");
            const fn = this.getAttribute("data-filename");
            const a = document.createElement("a");
            a.href = url;
            a.download = fn;
            a.click();
          });
        });
      } else {
        resultContent.innerHTML = '<span class="error">æœªå–å¾—åœ–ç‰‡ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</span>';
      }
    } catch (err) {
      stopTimer();
      timerDisplay.style.display = "none";
      resultContent.innerHTML = '<span class="error">è«‹æ±‚å¤±æ•—ï¼š' + escapeHtml(err.message) + '</span>';
    } finally {
      submitBtn.disabled = false;
    }
  });
})();
</script>
